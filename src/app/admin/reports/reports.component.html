<!-- Navbar -->
<app-navbar [isAdmin]="true"></app-navbar>

<div class="reports-wrapper bg-light min-vh-100">
  <div class="container-fluid px-4 py-5">

    <!-- Header -->
    <div class="d-flex justify-content-between align-items-center mb-4">
      <div>
        <h2 class="fw-bold mb-1">
          <i class="bi bi-file-earmark-text text-primary me-2"></i>
          Laporan Inventaris
        </h2>
        <p class="text-muted mb-0">Laporan lengkap produk, user, dan kategori</p>
      </div>
      <button class="btn btn-outline-secondary" (click)="goBack()">
        <i class="bi bi-arrow-left me-2"></i>
        Kembali
      </button>
    </div>

    <!-- Action Buttons -->
    <div class="d-flex flex-wrap gap-2 mb-4 print-hide">
      <button class="btn btn-success" (click)="printReport()">
        <i class="bi bi-printer me-2"></i>
        Cetak
      </button>
      <div class="input-group" style="max-width: 250px;">
        <select class="form-select" [(ngModel)]="exportFormat">
          <option value="csv">CSV</option>
          <option value="json">JSON</option>
          <option value="pdf">PDF</option>
        </select>
        <button class="btn btn-primary" (click)="exportReport()">
          <i class="bi bi-download me-2"></i>
          Export
        </button>
      </div>
    </div>

    <!-- Loading -->
    <div *ngIf="loading" class="text-center py-5">
      <div class="spinner-border text-primary" role="status">
        <span class="visually-hidden">Loading...</span>
      </div>
      <p class="mt-3 text-muted">Memuat laporan...</p>
    </div>

    <!-- Error -->
    <div *ngIf="errorMessage && !loading" class="alert alert-danger">
      {{ errorMessage }}
    </div>

    <!-- Tab Navigation -->
    <div class="nav nav-tabs mb-4 print-hide" role="tablist">
      <button class="nav-link" 
              [class.active]="activeTab === 'overview'"
              (click)="switchTab('overview')">
        <i class="bi bi-bar-chart me-2"></i>
        Ringkasan
      </button>
      <button class="nav-link" 
              [class.active]="activeTab === 'product'"
              (click)="switchTab('product')">
        <i class="bi bi-box-seam me-2"></i>
        Produk
      </button>
      <button class="nav-link" 
              [class.active]="activeTab === 'user'"
              (click)="switchTab('user')">
        <i class="bi bi-people me-2"></i>
        User
      </button>
      <button class="nav-link" 
              [class.active]="activeTab === 'category'"
              (click)="switchTab('category')">
        <i class="bi bi-grid-3x3-gap me-2"></i>
        Kategori
      </button>
      <button class="nav-link" 
              [class.active]="activeTab === 'stock'"
              (click)="switchTab('stock')">
        <i class="bi bi-exclamation-triangle me-2"></i>
        Stok
      </button>
    </div>

    <!-- OVERVIEW TAB -->
    <div *ngIf="activeTab === 'overview' && !loading">
      <!-- Summary Cards -->
      <div class="row g-4 mb-5">
        <div class="col-md-3">
          <div class="card border-0 shadow-sm h-100 stat-card">
            <div class="card-body p-4">
              <div class="d-flex justify-content-between align-items-start">
                <div>
                  <p class="text-muted small mb-1">Total Produk</p>
                  <h2 class="fw-bold mb-0">{{ reportData.totalProducts }}</h2>
                </div>
                <div class="stat-icon bg-primary-light">
                  <i class="bi bi-box-seam text-primary fs-3"></i>
                </div>
              </div>
            </div>
          </div>
        </div>

        <div class="col-md-3">
          <div class="card border-0 shadow-sm h-100 stat-card">
            <div class="card-body p-4">
              <div class="d-flex justify-content-between align-items-start">
                <div>
                  <p class="text-muted small mb-1">Total User</p>
                  <h2 class="fw-bold mb-0">{{ reportData.totalUsers }}</h2>
                </div>
                <div class="stat-icon bg-success-light">
                  <i class="bi bi-people text-success fs-3"></i>
                </div>
              </div>
            </div>
          </div>
        </div>

        <div class="col-md-3">
          <div class="card border-0 shadow-sm h-100 stat-card">
            <div class="card-body p-4">
              <div class="d-flex justify-content-between align-items-start">
                <div>
                  <p class="text-muted small mb-1">Total Kategori</p>
                  <h2 class="fw-bold mb-0">{{ reportData.totalCategories }}</h2>
                </div>
                <div class="stat-icon bg-warning-light">
                  <i class="bi bi-grid-3x3-gap text-warning fs-3"></i>
                </div>
              </div>
            </div>
          </div>
        </div>

        <div class="col-md-3">
          <div class="card border-0 shadow-sm h-100 stat-card">
            <div class="card-body p-4">
              <div class="d-flex justify-content-between align-items-start">
                <div>
                  <p class="text-muted small mb-1">Total Revenue</p>
                  <h2 class="fw-bold mb-0">Rp {{ reportData.totalRevenue | number:'1.0-0' }}</h2>
                </div>
                <div class="stat-icon bg-info-light">
                  <i class="bi bi-cash-coin text-info fs-3"></i>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>

      <!-- Status Distribution -->
      <div class="row g-4 mb-5">
        <div class="col-md-6">
          <div class="card border-0 shadow-sm h-100">
            <div class="card-body p-4">
              <h5 class="fw-bold mb-4">Status Produk</h5>
              <div class="status-list">
                <div class="status-item mb-3">
                  <div class="d-flex justify-content-between align-items-center mb-2">
                    <span class="fw-semibold">Aktif</span>
                    <span class="badge bg-success">{{ reportData.activeProducts }}</span>
                  </div>
                  <div class="progress" style="height: 8px;">
                    <div class="progress-bar bg-success" 
                         [style.width.%]="(reportData.activeProducts / reportData.totalProducts * 100)"></div>
                  </div>
                </div>

                <div class="status-item mb-3">
                  <div class="d-flex justify-content-between align-items-center mb-2">
                    <span class="fw-semibold">Menipis</span>
                    <span class="badge bg-warning">{{ reportData.lowStockProducts }}</span>
                  </div>
                  <div class="progress" style="height: 8px;">
                    <div class="progress-bar bg-warning" 
                         [style.width.%]="(reportData.lowStockProducts / reportData.totalProducts * 100)"></div>
                  </div>
                </div>

                <div class="status-item">
                  <div class="d-flex justify-content-between align-items-center mb-2">
                    <span class="fw-semibold">Nonaktif</span>
                    <span class="badge bg-secondary">{{ reportData.outOfStockProducts }}</span>
                  </div>
                  <div class="progress" style="height: 8px;">
                    <div class="progress-bar bg-secondary" 
                         [style.width.%]="(reportData.outOfStockProducts / reportData.totalProducts * 100)"></div>
                  </div>
                </div>
              </div>
            </div>
          </div>
        </div>

        <div class="col-md-6">
          <div class="card border-0 shadow-sm h-100">
            <div class="card-body p-4">
              <h5 class="fw-bold mb-4">Distribusi User</h5>
              <div class="status-list">
                <div class="status-item mb-3">
                  <div class="d-flex justify-content-between align-items-center mb-2">
                    <span class="fw-semibold">Administrator</span>
                    <span class="badge bg-danger">{{ reportData.userRoleDistribution.admin }}</span>
                  </div>
                  <div class="progress" style="height: 8px;">
                    <div class="progress-bar bg-danger" 
                         [style.width.%]="(reportData.userRoleDistribution.admin / reportData.totalUsers * 100)"></div>
                  </div>
                </div>

                <div class="status-item mb-3">
                  <div class="d-flex justify-content-between align-items-center mb-2">
                    <span class="fw-semibold">User Biasa</span>
                    <span class="badge bg-primary">{{ reportData.userRoleDistribution.user }}</span>
                  </div>
                  <div class="progress" style="height: 8px;">
                    <div class="progress-bar bg-primary" 
                         [style.width.%]="(reportData.userRoleDistribution.user / reportData.totalUsers * 100)"></div>
                  </div>
                </div>

                <div class="status-item">
                  <div class="d-flex justify-content-between align-items-center mb-2">
                    <span class="fw-semibold">User Aktif</span>
                    <span class="badge bg-success">{{ reportData.userStatusDistribution.aktif }}</span>
                  </div>
                  <div class="progress" style="height: 8px;">
                    <div class="progress-bar bg-success" 
                         [style.width.%]="(reportData.userStatusDistribution.aktif / reportData.totalUsers * 100)"></div>
                  </div>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>

      <!-- Top Products -->
      <div class="card border-0 shadow-sm mb-5">
        <div class="card-body p-4">
          <h5 class="fw-bold mb-4">5 Produk Terlaris</h5>
          <div class="table-responsive">
            <table class="table align-middle mb-0">
              <thead class="table-light">
                <tr>
                  <th>Produk</th>
                  <th>Terjual</th>
                  <th>Harga</th>
                  <th>Revenue</th>
                  <th>Stok</th>
                </tr>
              </thead>
              <tbody>
                <tr *ngFor="let product of reportData.topProducts">
                  <td class="fw-semibold">{{ product.name }}</td>
                  <td><span class="badge bg-info">{{ product.sold }}</span></td>
                  <td>Rp {{ product.price | number:'1.0-0' }}</td>
                  <td class="text-success fw-semibold">Rp {{ product.revenue | number:'1.0-0' }}</td>
                  <td>{{ product.stock }}</td>
                </tr>
                <tr *ngIf="reportData.topProducts.length === 0">
                  <td colspan="5" class="text-center text-muted py-4">Tidak ada data</td>
                </tr>
              </tbody>
            </table>
          </div>
        </div>
      </div>
    </div>

    <!-- PRODUCT TAB -->
    <div *ngIf="activeTab === 'product' && !loading">
      <div class="card border-0 shadow-sm mb-4">
        <div class="card-body p-4">
          <div class="row g-3 mb-4">
            <div class="col-md-6">
              <label class="form-label">Kategori</label>
              <select class="form-select" [(ngModel)]="selectedCategory">
                <option>Semua</option>
                <option *ngFor="let cat of categories" [value]="cat.name">
                  {{ cat.name | titlecase }}
                </option>
              </select>
            </div>
            <div class="col-md-6">
              <label class="form-label">Status</label>
              <select class="form-select" [(ngModel)]="selectedStatus">
                <option>Semua</option>
                <option value="Aktif">Aktif</option>
                <option value="Menipis">Menipis</option>
                <option value="Nonaktif">Nonaktif</option>
              </select>
            </div>
          </div>

          <div class="table-responsive">
            <table class="table align-middle">
              <thead class="table-light">
                <tr>
                  <th>Nama Produk</th>
                  <th>Kategori</th>
                  <th>Harga</th>
                  <th>Stok</th>
                  <th>Status</th>
                </tr>
              </thead>
              <tbody>
                <tr *ngFor="let product of getFilteredProducts()">
                  <td class="fw-semibold">{{ product.name }}</td>
                  <td>{{ product.category | titlecase }}</td>
                  <td>Rp {{ product.price | number:'1.0-0' }}</td>
                  <td>{{ product.stock }}</td>
                  <td>
                    <span class="badge" 
                          [ngClass]="{
                            'bg-success': product.status === 'Aktif',
                            'bg-warning': product.status === 'Menipis',
                            'bg-secondary': product.status === 'Nonaktif'
                          }">
                      {{ product.status }}
                    </span>
                  </td>
                </tr>
                <tr *ngIf="getFilteredProducts().length === 0">
                  <td colspan="5" class="text-center text-muted py-4">Tidak ada data</td>
                </tr>
              </tbody>
            </table>
          </div>
        </div>
      </div>
    </div>

    <!-- USER TAB -->
    <div *ngIf="activeTab === 'user' && !loading">
      <div class="card border-0 shadow-sm mb-4">
        <div class="card-body p-4">
          <div class="mb-4">
            <label class="form-label">Role</label>
            <select class="form-select" [(ngModel)]="selectedRole" style="max-width: 300px;">
              <option>Semua</option>
              <option value="admin">Admin</option>
              <option value="user">User</option>
            </select>
          </div>

          <div class="table-responsive">
            <table class="table align-middle">
              <thead class="table-light">
                <tr>
                  <th>Nama</th>
                  <th>Username</th>
                  <th>Email</th>
                  <th>Role</th>
                  <th>Status</th>
                </tr>
              </thead>
              <tbody>
                <tr *ngFor="let user of getFilteredUsers()">
                  <td class="fw-semibold">{{ user.name }}</td>
                  <td>{{ user.username }}</td>
                  <td>{{ user.email }}</td>
                  <td>
                    <span class="badge" 
                          [ngClass]="user.role === 'admin' ? 'bg-danger' : 'bg-primary'">
                      {{ user.role | uppercase }}
                    </span>
                  </td>
                  <td>
                    <span class="badge" 
                          [ngClass]="user.status === 'aktif' ? 'bg-success' : 'bg-secondary'">
                      {{ user.status | titlecase }}
                    </span>
                  </td>
                </tr>
                <tr *ngIf="getFilteredUsers().length === 0">
                  <td colspan="5" class="text-center text-muted py-4">Tidak ada data</td>
                </tr>
              </tbody>
            </table>
          </div>
        </div>
      </div>
    </div>

    <!-- CATEGORY TAB -->
    <div *ngIf="activeTab === 'category' && !loading">
      <div class="card border-0 shadow-sm mb-4">
        <div class="card-body p-4">
          <div class="table-responsive">
            <table class="table align-middle">
              <thead class="table-light">
                <tr>
                  <th>Nama Kategori</th>
                  <th>Jumlah Produk</th>
                  <th>Persentase</th>
                  <th>Progress</th>
                </tr>
              </thead>
              <tbody>
                <tr *ngFor="let cat of reportData.categoryDistribution">
                  <td class="fw-semibold">{{ cat.name | titlecase }}</td>
                  <td><span class="badge bg-info">{{ cat.productCount }} produk</span></td>
                  <td>{{ cat.percentage }}%</td>
                  <td>
                    <div class="progress" style="height: 8px;">
                      <div class="progress-bar bg-primary" [style.width.%]="cat.percentage"></div>
                    </div>
                  </td>
                </tr>
                <tr *ngIf="reportData.categoryDistribution.length === 0">
                  <td colspan="4" class="text-center text-muted py-4">Tidak ada data</td>
                </tr>
              </tbody>
            </table>
          </div>
        </div>
      </div>
    </div>

    <!-- STOCK TAB -->
    <div *ngIf="activeTab === 'stock' && !loading">
      <div class="card border-0 shadow-sm mb-4">
        <div class="card-body p-4">
          <h5 class="fw-bold mb-4">Produk Stok Rendah & Habis</h5>
          
          <div class="row g-4 mb-4">
            <div class="col-md-6">
              <h6 class="fw-bold mb-3">Stok Menipis (< 5)</h6>
              <div class="table-responsive">
                <table class="table table-sm align-middle">
                  <thead class="table-light">
                    <tr>
                      <th>Produk</th>
                      <th>Stok</th>
                    </tr>
                  </thead>
                  <tbody>
                    <tr *ngFor="let product of getFilteredProducts() | slice:0:5">
                      <ng-container *ngIf="product.status === 'Menipis'">
                        <td>{{ product.name }}</td>
                        <td><span class="badge bg-warning">{{ product.stock }}</span></td>
                      </ng-container>
                    </tr>
                  </tbody>
                </table>
              </div>
            </div>

            <div class="col-md-6">
              <h6 class="fw-bold mb-3">Stok Habis</h6>
              <div class="table-responsive">
                <table class="table table-sm align-middle">
                  <thead class="table-light">
                    <tr>
                      <th>Produk</th>
                      <th>Stok</th>
                    </tr>
                  </thead>
                  <tbody>
                    <tr *ngFor="let product of getFilteredProducts() | slice:0:5">
                      <ng-container *ngIf="product.status === 'Nonaktif'">
                        <td>{{ product.name }}</td>
                        <td><span class="badge bg-danger">{{ product.stock }}</span></td>
                      </ng-container>
                    </tr>
                  </tbody>
                </table>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>

  </div>
</div>