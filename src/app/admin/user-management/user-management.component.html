<!-- Navbar -->
<app-navbar [isAdmin]="true"></app-navbar>

<div class="container-fluid py-4 px-5 bg-light min-vh-100">

  <!-- Header -->
  <div class="d-flex justify-content-between align-items-center mb-4">
    <div>
      <h4 class="fw-bold mb-1">Management User</h4>
      <p class="text-muted mb-0">Kelola semua user dalam sistem.</p>
    </div>
    <div class="d-flex gap-2">
    <!-- ✅ HAPUS PERMANEN BUTTON -->
      <button class="btn btn-outline-danger" (click)="openDeletePermanentModal()">
        <i class="bi bi-trash me-1"></i> Hapus User Permanen
      </button>
      <button class="btn btn-warning text-white fw-semibold" data-bs-toggle="modal" data-bs-target="#tambahUserModal">
        <i class="bi bi-plus-lg me-1"></i> Tambah User
      </button>
    </div>
  </div>

  <!-- Search & Filter -->
  <div class="d-flex flex-wrap align-items-center gap-2 mb-4">
    <div class="flex-grow-1">
      <input type="text" class="form-control" placeholder="Cari user..." />
    </div>
    <select class="form-select w-auto pe-5">
      <option>Semua Status</option>
      <option>Active</option>
      <option>Nonaktif</option>
    </select>
    <button class="btn btn-outline-secondary">
      <i class="bi bi-funnel"></i> Filter
    </button>
  </div>

  <!-- Daftar User -->
  <div class="mt-4">
    <div class="card border-0 shadow-sm">
      <div class="card-body p-0">
        <div class="table-responsive">
          <table class="table align-middle mb-0">
            <thead class="table-light">
              <tr>
                <th>Nama User</th>
                <th>No. Telepon</th>
                <th>Tanggal Dibuat</th>
                <th>Username</th>
                <th>E-Mail</th>
                <th>Role</th>
                <th>Status</th>
                <th></th>
              </tr>
            </thead>
            <tbody>
              <tr *ngFor="let user of users">
                <td><strong>{{ user.name }}</strong></td>
                <td>{{ user.phone }}</td>
                <td>{{ user.createdAt | date:'dd/MM/yyyy' }}</td>
                <td>
                  <span class="text-muted">{{ user.username }}</span>
                </td>
                <td>{{ user.email }}</td>
                <!-- ✅ ROLE - Pakai Custom Badge -->
                <td>
                    <span class="custom-badge badge-{{ user.role }}">
                        {{ user.role | uppercase }}
                    </span>
                </td>
                
                <!-- ✅ STATUS - Pakai Custom Badge -->
                <td>
                    <span class="custom-badge badge-{{ user.status }}">
                        {{ user.status | uppercase }}
                    </span>
                </td>
                <td class="text-center">
                  <div class="dropdown-custom position-relative">
                    <button class="btn btn-sm btn-light" (click)="toggleDropdown(user._id)" type="button">
                      <i class="bi bi-three-dots-vertical"></i>
                    </button>
                    <div class="dropdown-menu-custom" [class.show]="openDropdownId === user._id" 
                         *ngIf="openDropdownId === user._id">
                      <a class="dropdown-item-custom" (click)="editUser(user)">
                        <i class="bi bi-pencil me-2"></i> Edit
                      </a>
                      <a class="dropdown-item-custom" (click)="resetPassword(user)">
                        <i class="bi bi-lock me-2"></i> Reset Password
                      </a>
                      <div class="dropdown-divider-custom"></div>
                      <a class="dropdown-item-custom text-danger" (click)="deleteUser(user)">
                        <i class="bi bi-ban me-2"></i> Block User
                      </a>
                    </div>
                  </div>
                  <div class="dropdown-overlay" *ngIf="openDropdownId === user._id" (click)="closeDropdown()"></div>
                </td>
              </tr>
              <tr *ngIf="users.length === 0">
                <td colspan="8" class="text-center py-4 text-muted">
                  Tidak ada user yang ditemukan
                </td>
              </tr>
            </tbody>
          </table>
        </div>
      </div>
    </div>
  </div>
</div>

<!-- Modal Tambah User -->
<div class="modal fade" id="tambahUserModal" tabindex="-1" aria-labelledby="tambahUserLabel" aria-hidden="true">
  <div class="modal-dialog modal-dialog-centered modal-lg">
    <div class="modal-content">
      <!-- Header -->
      <div class="modal-header">
        <div>
          <h5 class="modal-title" id="tambahUserLabel">Tambah User</h5>
          <p class="description-text mb-0">Masukkan detail user untuk menambahkannya ke management user</p>
        </div>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>

      <!-- Body -->
      <div class="modal-body">
        <form id="userForm" (ngSubmit)="addUser()">
          <!-- Upload Gambar -->
          <div class="row-gap mb-3">
            <div class="upload-area" onclick="document.getElementById('imageInput').click()">
              <div class="upload-icon">
                <i class="bi bi-image"></i>
              </div>
              <div class="upload-text">Unggah Gambar</div>
            </div>
            <input type="file" id="imageInput" accept="image/*" style="display: none;">
          </div>

          <!-- Nama User & No Telphone -->
          <div class="row mb-3">
            <div class="col-md-6">
              <label for="namaUser" class="form-label">Nama User<span class="text-danger">*</span></label>
              <input type="text" [(ngModel)]="form.name" name="name" class="form-control" id="namaUser" placeholder="Masukan nama user" required>
            </div>
            <div class="col-md-6">
              <label for="noTelphone" class="form-label">No Telphone<span class="text-danger">*</span></label>
              <input type="text" [(ngModel)]="form.phone" name="phone" class="form-control" id="noTelphone" placeholder="Masukan nomor telepon" required>
            </div>
          </div>

          <!-- Username & Password -->
          <div class="row mb-3">
            <div class="col-md-6">
              <label for="username" class="form-label">Username<span class="text-danger">*</span></label>
              <input type="text" [(ngModel)]="form.username" name="username" class="form-control" id="username" placeholder="Username" required>
            </div>
            <div class="col-md-6">
              <label for="password" class="form-label">Password<span class="text-danger">*</span></label>
              <input type="password" [(ngModel)]="form.password" name="password" class="form-control" id="password" placeholder="Password" required>
            </div>
          </div>

          <!-- Email -->
          <div class="mb-3">
            <label for="email" class="form-label">Email<span class="text-danger">*</span></label>
            <input type="email" [(ngModel)]="form.email" name="email" class="form-control" id="email" placeholder="Masukan Email" required>
          </div>

          <!-- Role & Status -->
          <div class="row mb-3">
            <div class="col-md-6">
              <label for="role" class="form-label">Pilih Role<span class="text-danger">*</span></label>
              <select class="form-select" id="role" [(ngModel)]="form.role" name="role" required>
                <option value="">-- Pilih Role --</option>
                <option value="user">User</option>
                <option value="admin">Admin</option>
              </select>
            </div>
            <div class="col-md-6">
              <label class="form-label">Status User</label>
              <div class="form-check form-switch mt-2">
                <input class="form-check-input" [(ngModel)]="form.status" name="status" type="checkbox" id="statusToggle" role="switch">
                <label class="form-check-label" for="statusToggle">
                  <span id="statusLabel">{{ form.status ? 'Aktif' : 'Nonaktif' }}</span>
                </label>
              </div>
            </div>
          </div>

          <!-- Footer -->
          <div class="modal-footer">
            <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Batal</button>
            <button type="submit" class="btn btn-warning text-white fw-semibold">Tambah ✓</button>
          </div>
        </form>
      </div>
    </div>
  </div>
</div>

<!-- ========== MODAL DELETE PERMANEN USER ========== -->
<div class="modal fade" id="deletePermanentModal" tabindex="-1">
  <div class="modal-dialog modal-dialog-centered modal-lg">
    <div class="modal-content">
      <div class="modal-header border-danger border-bottom-2">
        <h5 class="modal-title text-danger fw-bold">
          <i class="bi bi-trash me-2"></i> Hapus User Secara Permanen
        </h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
      </div>

      <div class="modal-body">
        <div class="alert alert-danger mb-4">
          <i class="bi bi-exclamation-triangle-fill me-2"></i>
          <strong>Peringatan!</strong> User yang dihapus tidak dapat dipulihkan kembali.
        </div>

        <!-- Select All Checkbox -->
        <div class="mb-3">
          <div class="form-check">
            <input type="checkbox" class="form-check-input" id="selectAllCheck"
                   [checked]="selectedForDelete.length === users.length && users.length > 0"
                   (change)="toggleSelectAll()">
            <label class="form-check-label fw-semibold" for="selectAllCheck">
              Pilih Semua ({{ users.length }} user)
            </label>
          </div>
        </div>

        <hr>

        <!-- List User -->
        <div style="max-height: 400px; overflow-y: auto; overflow-x: hidden;">
          <div *ngIf="users.length === 0" class="text-center text-muted py-5">
            <i class="bi bi-inbox" style="font-size: 2rem;"></i>
            <p class="mt-2">Tidak ada user</p>
          </div>

          <div *ngFor="let user of users" class="mb-2 p-3 border rounded" style="display: flex; align-items: center; gap: 12px; min-width: 0;">
            <input type="checkbox" class="form-check-input flex-shrink-0" [id]="'user-' + user._id"
                   [checked]="isUserSelected(user._id)"
                   (change)="toggleSelectForDelete(user._id!)"
                   style="margin: 0; cursor: pointer;">
            <label class="flex-grow-1" [for]="'user-' + user._id" style="cursor: pointer; margin: 0; min-width: 0;">
              <div class="d-flex align-items-center justify-content-between" style="gap: 12px; min-width: 0;">
                <div style="min-width: 0; overflow: hidden;">
                  <strong style="display: block; white-space: nowrap; overflow: hidden; text-overflow: ellipsis;">{{ user.name }}</strong>
                  <small class="text-muted" style="display: block; white-space: nowrap; overflow: hidden; text-overflow: ellipsis;">{{ user.username }} • {{ user.email }}</small>
                </div>
                <span class="badge bg-secondary flex-shrink-0">{{ user.role | uppercase }}</span>
              </div>
            </label>
          </div>
        </div>

        <hr class="mt-3">

        <!-- Summary -->
        <div class="alert alert-light">
          <strong>{{ selectedForDelete.length }}</strong> user dipilih untuk dihapus
        </div>
      </div>

      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Batal</button>
        <button type="button" class="btn btn-danger" 
                (click)="deleteSelectedPermanently()"
                [disabled]="loading || selectedForDelete.length === 0"
                style="min-width: 180px;">
          <i class="bi bi-trash me-2"></i>
          <span *ngIf="!loading">
            Hapus {{ selectedForDelete.length > 0 ? selectedForDelete.length + ' User' : '' }}
          </span>
          <span *ngIf="loading">
            <span class="spinner-border spinner-border-sm me-2"></span>
            Menghapus...
          </span>
        </button>
      </div>
    </div>
  </div>
</div>

<!-- ========== MODAL EDIT USER ========== -->
<div class="modal fade" id="editUserModal" tabindex="-1" aria-labelledby="editUserLabel" aria-hidden="true">
  <div class="modal-dialog modal-dialog-centered modal-lg">
    <div class="modal-content">
      <!-- Header -->
      <div class="modal-header">
        <div>
          <h5 class="modal-title" id="editUserLabel">Edit User</h5>
          <p class="description-text mb-0">Update informasi user</p>
        </div>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>

      <!-- Body -->
      <div class="modal-body">
        <!-- Error Message -->
        <div *ngIf="errorMessage" class="alert alert-danger alert-dismissible fade show" role="alert">
          <i class="bi bi-exclamation-circle me-2"></i>
          {{ errorMessage }}
          <button type="button" class="btn-close" (click)="errorMessage = ''"></button>
        </div>

        <form (ngSubmit)="saveEditUser()">
          <!-- Nama User & No Telphone -->
          <div class="row mb-3">
            <div class="col-md-6">
              <label for="editNamaUser" class="form-label">Nama User<span class="text-danger">*</span></label>
              <input type="text" 
                     [(ngModel)]="editForm.name" 
                     name="name" 
                     class="form-control" 
                     id="editNamaUser" 
                     placeholder="Masukan nama user" 
                     required>
            </div>
            <div class="col-md-6">
              <label for="editNoTelphone" class="form-label">No Telphone<span class="text-danger">*</span></label>
              <input type="text" 
                     [(ngModel)]="editForm.phone" 
                     name="phone" 
                     class="form-control" 
                     id="editNoTelphone" 
                     placeholder="Masukan nomor telepon" 
                     required>
            </div>
          </div>

          <!-- Username & Email -->
          <div class="row mb-3">
            <div class="col-md-6">
              <label for="editUsername" class="form-label">Username<span class="text-danger">*</span></label>
              <input type="text" 
                     [(ngModel)]="editForm.username" 
                     name="username" 
                     class="form-control" 
                     id="editUsername" 
                     placeholder="Username" 
                     required>
              <small class="text-muted">Username tidak bisa diubah</small>
            </div>
            <div class="col-md-6">
              <label for="editEmail" class="form-label">Email<span class="text-danger">*</span></label>
              <input type="email" 
                     [(ngModel)]="editForm.email" 
                     name="email" 
                     class="form-control" 
                     id="editEmail" 
                     placeholder="Masukan Email" 
                     required>
            </div>
          </div>

          <!-- Role & Status -->
          <div class="row mb-3">
            <div class="col-md-6">
              <label for="editRole" class="form-label">Pilih Role<span class="text-danger">*</span></label>
              <select class="form-select" id="editRole" [(ngModel)]="editForm.role" name="role" required>
                <option value="user">User</option>
                <option value="admin">Admin</option>
              </select>
            </div>
            <div class="col-md-6">
              <label class="form-label">Status User</label>
              <div class="form-check form-switch mt-2">
                <input class="form-check-input" 
                       [(ngModel)]="editForm.statusToggle"
                       (change)="editForm.status = editForm.statusToggle ? 'aktif' : 'nonaktif'"
                       name="statusToggle"
                       type="checkbox" 
                       id="editStatusToggle" 
                       role="switch">
                <label class="form-check-label" for="editStatusToggle">
                  <span>{{ editForm.status === 'aktif' ? 'Aktif' : 'Nonaktif' }}</span>
                </label>
              </div>
            </div>
          </div>

          <!-- Info Message -->
          <div class="alert alert-info">
            <i class="bi bi-info-circle me-2"></i>
            <small>Untuk mengubah password user, gunakan fitur "Reset Password" di dropdown menu.</small>
          </div>

          <!-- Footer -->
          <div class="modal-footer">
            <button type="button" 
                    class="btn btn-secondary" 
                    (click)="cancelEditUser()"
                    data-bs-dismiss="modal">
              Batal
            </button>
            <button type="submit" 
                    class="btn btn-warning text-white fw-semibold"
                    [disabled]="loading">
              <span *ngIf="!loading">
                <i class="bi bi-check-circle me-2"></i>
                Update User
              </span>
              <span *ngIf="loading">
                <span class="spinner-border spinner-border-sm me-2"></span>
                Memperbarui...
              </span>
            </button>
          </div>
        </form>
      </div>
    </div>
  </div>
</div>